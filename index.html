<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>åˆè¡¡ä»»å‹™æ¢ï½œMissionTrackâ€‘H</title>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <style>
    :root{
      --fg:#e8f4ff;
      --muted:#9db7cf;
      --primary:#4da3ff;
      --accent:#7cd2ff;
      --ok:#49d17d;
      --warn:#ffb020;
      --bg:#0b1220;
      --glass:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);font-family: ui-sans-serif,system-ui,"PingFang TC","Noto Sans TC",Segoe UI,Roboto,Helvetica,Arial}
    /* å‹•æ…‹å£ç´™ï¼šè—å…‰èƒ½é‡æµ */
    .wallpaper{
      position:fixed;inset:0;
      background: radial-gradient(1200px 600px at 20% 20%,rgba(80,160,255,.35),transparent 60%),
                  radial-gradient(1000px 500px at 80% 80%,rgba(120,220,255,.25),transparent 60%),
                  radial-gradient(900px 700px at 50% 120%,rgba(60,120,255,.18),transparent 60%),
                  linear-gradient(120deg,#081018,#0b1422,#0f1c30);
      filter:saturate(115%);
      overflow:hidden;
    }
    .energy{
      position:absolute;inset:-20%;
      background: conic-gradient(from 0deg,#4da3ff22,#7cd2ff33,#4da3ff22,#0000 70%);
      animation: swirl 18s linear infinite;
      mix-blend-mode:screen;
      opacity:.5;
    }
    @keyframes swirl { to { transform: rotate(360deg);} }

    /* å®¹å™¨ */
    .wrap{position:relative;display:flex;flex-direction:column;min-height:100%;padding:24px}
    header{
      display:flex;align-items:center;gap:12px;color:var(--fg);
      backdrop-filter: blur(8px); background: var(--glass);
      border:1px solid rgba(255,255,255,.08);
      padding:8px 14px;border-radius:12px; width:max-content;
    }
    header .dot{width:10px;height:10px;border-radius:50%;background:var(--primary);box-shadow:0 0 16px var(--accent);animation: pulse 1.6s ease-in-out infinite}
    @keyframes pulse { 0%,100%{transform:scale(.85);opacity:.7} 50%{transform:scale(1.15);opacity:1}}

    /* ä»»å‹™æ¢ */
    .panel{
      margin:42px auto 0; width:min(960px,92%);
      background: var(--glass); border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:18px 18px 20px 18px; color:var(--fg);
      backdrop-filter: blur(12px);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .badge{font-size:12px;padding:4px 10px;border-radius:12px;background:#102035;border:1px solid #24405a;color:#a6c4df}
    .bar{height:18px;background:#0e1b2b;border-radius:10px;overflow:hidden;position:relative}
    .fill{height:100%;width:0%;background:linear-gradient(90deg,var(--primary),var(--accent));box-shadow:0 0 30px var(--accent);transition:width .45s ease}
    .marks{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:8px}
    .grid{display:grid;grid-template-columns:1.3fr .7fr; gap:14px; margin-top:16px}
    .card{background:rgba(8,20,36,.45);border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px}
    .card h4{margin:0 0 8px 0; font-size:14px;color:#cfe7ff}
    .trace{max-height:180px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12.5px; white-space:pre-wrap; color:#c7e1ff}
    .kv{display:flex;gap:14px; flex-wrap:wrap;color:#cde2ff;font-size:13px}
    .kv b{color:#9ad1ff}
    footer{color:#8fb6d6; font-size:12px; margin-top:10px; text-align:right}
    .nodeRow{display:flex;gap:8px;flex-wrap:wrap}
    .node{width:12px;height:12px;border-radius:50%;background:#123;box-shadow:inset 0 0 0 1px #2b4b6b;opacity:.65}
    .node.active{background:#53b7ff; box-shadow:0 0 12px #53b7ff, inset 0 0 0 1px #bfe6ff; opacity:1}
  </style>
</head>
<body>
  <div class="wallpaper">
    <div class="energy"></div>
  </div>
  <div class="wrap">
    <header>
      <div class="dot"></div>
      <strong>åˆè¡¡ãƒ»ä»»å‹™ç›£æ§</strong>
      <span class="badge" id="status">åˆå§‹åŒ–</span>
    </header>

    <section class="panel">
      <div class="title">
        <div>
          <h3 style="margin:0 0 6px 0">ä»»å‹™ï¼š<span id="task_id">â€”</span></h3>
          <div class="nodeRow">
            <div class="node" id="nS1" title="S1 åˆå§‹åŒ–"></div>
            <div class="node" id="nS2" title="S2 ä¸»é«”è’é›†"></div>
            <div class="node" id="nS3" title="S3 åˆ†ææ•´ä½µ"></div>
            <div class="node" id="nS4" title="S4 è¼¸å‡ºæ ¼å¼åŒ–"></div>
          </div>
        </div>
        <span class="badge" id="stage">S1</span>
      </div>

      <div class="bar"><div class="fill" id="fill"></div></div>
      <div class="marks">
        <div>é€²åº¦ <b id="pct">0%</b></div>
        <div>ETA <b id="eta">--</b></div>
        <div>æ›´æ–° <b id="upd">--</b></div>
      </div>

      <div class="grid">
        <div class="card">
          <h4>æ€è€ƒæµï¼ˆtraceï¼‰</h4>
          <div class="trace" id="trace"></div>
        </div>
        <div class="card">
          <h4>ä»»å‹™è³‡è¨Š</h4>
          <div class="kv">
            <div>ç¸½é‡ <b id="total">0</b></div>
            <div>å®Œæˆ <b id="done">0</b></div>
            <div>éšæ®µ <b id="stage2">S1</b></div>
            <div>ç‹€æ…‹ <b id="status2">init</b></div>
          </div>
        </div>
      </div>
      <footer>MissionTrackâ€‘H â€¢ Firebase Realtime DB</footer>
    </section>
  </div>

  <!-- Firebase SDK v9 (modular) -->
  <script type="module">
    // ğŸ‘‰ğŸ‘‰ å°‡ä¸‹æ–¹ firebaseConfig æ›æˆä½ åœ¨ Firebase ç”¢ç”Ÿçš„è¨­å®š
    const firebaseConfig = {
      apiKey: "PASTE_API_KEY",
      authDomain: "PASTE_AUTH_DOMAIN",
      databaseURL: "PASTE_DB_URL",
      projectId: "PASTE_PROJECT_ID",
      storageBucket: "PASTE_BUCKET",
      messagingSenderId: "PASTE_SENDER_ID",
      appId: "PASTE_APP_ID"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ä»»å‹™ id ä¾†è‡ªç¶²å€ ?task_id=xxxï¼Œé è¨­ demo
    const params = new URLSearchParams(location.search);
    const TASK_ID = params.get('task_id') || 'demo_task';
    document.getElementById('task_id').textContent = TASK_ID;

    const el = (id)=>document.getElementById(id);
    const fmtETA = (s)=>{
      if (!s || isNaN(s)) return '--';
      s = Math.max(0, Math.floor(s));
      const m = Math.floor(s/60), r = s%60;
      return `${m}åˆ†${r}ç§’`;
    };
    const fmtTime = (ts)=>{
      if (!ts) return '--';
      const d = new Date(ts);
      return d.toLocaleTimeString();
    };

    function mark(stage){
      ['nS1','nS2','nS3','nS4'].forEach((k,i)=>{
        const n = document.getElementById(k);
        const order = ['S1','S2','S3','S4'];
        n.classList.toggle('active', order.indexOf(stage) >= i);
      });
    }

    const missionRef = ref(db, 'missions/' + TASK_ID);
    onValue(missionRef, (snap)=>{
      const data = snap.val() || {};
      const total = Number(data.total||100);
      const done  = Number(data.done||0);
      const pct = Math.max(0, Math.min(100, Math.round(done/total*100)));
      el('fill').style.width = pct + '%';
      el('pct').textContent = pct + '%';
      el('eta').textContent = fmtETA(data.eta_sec);
      el('upd').textContent = fmtTime(data.updated_at || Date.now());
      el('total').textContent = total;
      el('done').textContent = done;
      el('stage').textContent = data.stage || 'S1';
      el('stage2').textContent = data.stage || 'S1';
      el('status').textContent = data.status || 'running';
      el('status2').textContent = data.status || 'running';
      mark((data.stage||'S1').split(':')[0].trim());

      const trace = Array.isArray(data.trace) ? data.trace : [];
      el('trace').textContent = trace.map(t=>`â€¢ ${t.msg || t} (${fmtTime((t.t||Date.now())*1000)})`).join('\n');
      if (pct >= 100 || (data.status||'')==='done'){
        el('fill').style.background = 'linear-gradient(90deg,#49d17d,#7cf0b7)';
      }
    }, {onlyOnce:false});
  </script>
</body>
</html>
