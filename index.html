<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>初衡・任務監控 MissionTrack‑H</title>
<meta name="color-scheme" content="dark light"/>
<style>
  :root{
    --fg:#e8f4ff; --muted:#9db7cf; --primary:#4da3ff; --accent:#7cd2ff;
    --ok:#49d17d; --warn:#ffb020; --bg:#0b1220; --glass:rgba(255,255,255,.08);
    --panel:rgba(10,18,36,.55); --border:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);
    font-family:ui-sans-serif,system-ui,"PingFang TC","Noto Sans TC",Segoe UI,Roboto,Helvetica,Arial}
  /* 動態壁紙 */
  .wallpaper{position:fixed;inset:0;pointer-events:none;
    background:radial-gradient(1200px 600px at 20% 20%,rgba(80,160,255,.35),transparent 60%),
               radial-gradient(1000px 500px at 80% 80%,rgba(120,220,255,.25),transparent 60%),
               radial-gradient(900px 700px at 50% 120%,rgba(60,120,255,.18),transparent 60%),
               linear-gradient(120deg,#081018,#0b1422,#0f1c30);filter:saturate(115%)}
  .energy{position:absolute;inset:-20%;background:conic-gradient(from 0deg,#4da3ff22,#7cd2ff33,#4da3ff22,#0000 70%);
    animation:swirl 18s linear infinite;mix-blend-mode:screen;opacity:.5}
  @keyframes swirl{to{transform:rotate(360deg)}}

  .wrap{position:relative;display:flex;flex-direction:column;min-height:100%;padding:24px}
  header{display:flex;align-items:center;gap:12px;color:var(--fg);backdrop-filter:blur(8px);
    background:var(--glass);border:1px solid var(--border);padding:8px 14px;border-radius:12px;width:max-content}
  header .dot{width:10px;height:10px;border-radius:50%;background:#888;box-shadow:0 0 10px #888}
  header.online .dot{background:var(--primary);box-shadow:0 0 16px var(--accent)}

  .panel{margin:42px auto 0;width:min(980px,92%);background:var(--panel);
    border:1px solid var(--border);border-radius:16px;padding:18px 18px 20px;color:var(--fg);
    backdrop-filter:blur(12px);box-shadow:0 20px 60px rgba(0,0,0,.35)}
  .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .badge{font-size:12px;padding:4px 10px;border-radius:12px;background:#102035;border:1px solid #24405a;color:#a6c4df}
  .bar{height:18px;background:#0e1b2b;border-radius:10px;overflow:hidden;position:relative}
  .fill{height:100%;width:0%;background:linear-gradient(90deg,var(--primary),var(--accent));
    box-shadow:0 0 30px var(--accent);transition:width .4s ease}
  .marks{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:8px}
  .grid{display:grid;grid-template-columns:1.3fr .7fr;gap:14px;margin-top:16px}
  .card{background:rgba(8,20,36,.45);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px}
  .card h4{margin:0 0 8px 0;font-size:14px;color:#cfe7ff}
  .trace{max-height:220px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;
    font-size:12.5px;white-space:pre-wrap;color:#c7e1ff}
  .kv{display:flex;gap:14px;flex-wrap:wrap;color:#cde2ff;font-size:13px}
  .kv b{color:#9ad1ff}
  .nodeRow{display:flex;gap:8px;flex-wrap:wrap}
  .node{width:12px;height:12px;border-radius:50%;background:#123;box-shadow:inset 0 0 0 1px #2b4b6b;opacity:.65}
  .node.active{background:#53b7ff;box-shadow:0 0 12px #53b7ff,inset 0 0 0 1px #bfe6ff;opacity:1}
  footer{color:#8fb6d6;font-size:12px;margin-top:10px;text-align:right}
  .hint{color:#a8c7e6;font-size:12px;margin-top:10px}

  /* Chat-style feed */
  .chat {position:fixed;right:16px;bottom:16px;left:16px;max-width:720px;margin:0 auto;
    display:flex;flex-direction:column;gap:12px;pointer-events:none}
  .bubble {background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
    color:var(--fg);border-radius:16px;padding:12px 14px;backdrop-filter:blur(8px);
    box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .bubble .h {font-weight:700;margin-bottom:4px}
  .bubble .s {opacity:.85;font-size:13px}
  .badge-dot{display:inline-flex;align-items:center;gap:8px}
  .dot-blue,.dot-green,.dot-amber{width:10px;height:10px;border-radius:50%}
  .dot-blue{background:#5aa8ff;box-shadow:0 0 12px #5aa8ff}
  .dot-green{background:#39d67d;box-shadow:0 0 12px #39d67d}
  .dot-amber{background:#ffb020;box-shadow:0 0 12px #ffb020}
  .spin{width:14px;height:14px;border-radius:50%;border:2px solid #7cd2ff55;border-top-color:#7cd2ff;
    display:inline-block;animation:sp 1s linear infinite;vertical-align:-2px;margin-right:6px}
  @keyframes sp {to{transform:rotate(360deg)}}

  .top-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{background:#0f2238;color:#cfe7ff;border:1px solid #294866;padding:8px 12px;border-radius:10px;cursor:pointer}
  button:hover{filter:brightness(1.1)}
</style>
</head>
<body>
<div class="wallpaper"><div class="energy"></div></div>

<div class="wrap">
  <header id="hdr">
    <div class="dot"></div><strong>初衡・任務監控</strong>
    <span class="badge" id="status">初始化</span>
  </header>

  <section class="panel">
    <div class="title">
      <div>
        <h3 style="margin:0 0 6px 0">任務：<span id="task_id">—</span></h3>
        <div class="nodeRow">
          <div class="node" id="nS1" title="S1 初始化"></div>
          <div class="node" id="nS2" title="S2 主體蒐集"></div>
          <div class="node" id="nS3" title="S3 分析整併"></div>
          <div class="node" id="nS4" title="S4 輸出格式化"></div>
        </div>
      </div>
      <span class="badge" id="stage">S1</span>
    </div>

    <div class="bar"><div class="fill" id="fill"></div></div>
    <div class="marks">
      <div>進度 <b id="pct">0%</b></div>
      <div>ETA <b id="eta">--</b></div>
      <div>更新 <b id="upd">--</b></div>
    </div>

    <div class="grid">
      <div class="card">
        <h4>思考流（trace）</h4>
        <div class="trace" id="trace"></div>
        <div class="top-actions">
          <button id="btnSim">開始模擬</button>
          <button id="btnReset">重置</button>
        </div>
      </div>
      <div class="card">
        <h4>任務資訊</h4>
        <div class="kv">
          <div>總量 <b id="total">100</b></div>
          <div>完成 <b id="done">0</b></div>
          <div>階段 <b id="stage2">S1</b></div>
          <div>狀態 <b id="status2">init</b></div>
        </div>
        <div class="hint">
          URL 參數：<code>?task_id=ID&simulate=1</code>；
          若未設定 Firebase，會自動進入離線 Demo。
        </div>
      </div>
    </div>
    <footer>MissionTrack‑H • Standalone / Firebase‑ready</footer>
  </section>
</div>

<!-- Chat-like progress feed -->
<div class="chat" id="chatFeed"></div>

<script type="module">
const params = new URLSearchParams(location.search);
const TASK_ID = params.get('task_id') || 'demo_task';
const SIMULATE = params.get('simulate') === '1' || params.get('demo') === '1';

/* Firebase 設定（可留空 → 自動走離線 Demo） */
const firebaseConfig = {
  // apiKey: "PASTE_API_KEY",
  // authDomain: "PASTE_AUTH_DOMAIN",
  // databaseURL: "https://<YOUR-PROJECT-ID>-default-rtdb.asia-southeast1.firebasedatabase.app",
  // projectId: "PASTE_PROJECT_ID",
  // storageBucket: "PASTE_BUCKET",
  // messagingSenderId: "PASTE_SENDER_ID",
  // appId: "PASTE_APP_ID"
};

const el = id => document.getElementById(id);
const fmtETA = s => (!s&&s!==0)?'--':`${Math.floor(s/60)}分${Math.max(0,Math.floor(s%60))}秒`;
const fmtTime = ts => ts ? new Date(ts).toLocaleTimeString() : '--';
const mark = stage => {
  ['nS1','nS2','nS3','nS4'].forEach((k,i)=>{
    const n = document.getElementById(k);
    const order = ['S1','S2','S3','S4'];
    n.classList.toggle('active', order.indexOf(stage)>=i);
  });
};
const feed = document.getElementById('chatFeed');
const pushBubble = (title, subtitle, dot='blue', spinning=false) => {
  const wrap = document.createElement('div'); wrap.className = 'bubble';
  wrap.innerHTML = `
    <div class="h">
      <span class="badge-dot">
        ${spinning ? '<span class="spin"></span>' : ''}
        <span class="dot-${dot}"></span> ${title}
      </span>
    </div>
    <div class="s">${subtitle||''}</div>`;
  feed.appendChild(wrap);
  while (feed.children.length > 6) feed.removeChild(feed.firstChild);
};

el('task_id').textContent = TASK_ID;

let online = Boolean(firebaseConfig.databaseURL && firebaseConfig.databaseURL.startsWith('http'));
const state = {
  total: 100, done: 0, stage: 'S1', status: 'init', eta_sec: 180, updated_at: Date.now(),
  trace: []
};
function render(){
  const pct = Math.max(0, Math.min(100, Math.round(state.done/state.total*100)));
  el('fill').style.width = pct + '%';
  el('pct').textContent = pct + '%';
  el('eta').textContent = fmtETA(state.eta_sec);
  el('upd').textContent = fmtTime(state.updated_at);
  el('total').textContent = state.total;
  el('done').textContent  = state.done;
  el('stage').textContent = state.stage;
  el('stage2').textContent= state.stage;
  el('status').textContent= state.status;
  el('status2').textContent= state.status;
  mark((state.stage||'S1').split(':')[0].trim());
  el('trace').textContent = state.trace.map(t=>`• ${t.msg} (${fmtTime(t.t*1000)})`).join('\\n');
  if (pct>=100 || state.status==='done'){
    el('fill').style.background='linear-gradient(90deg,#49d17d,#7cf0b7)';
  }
}
function addTrace(msg){ state.trace.push({t: Math.floor(Date.now()/1000), msg}); render(); }

function startSimulation(){
  pushBubble('思考', '正在生成任務上下文…', 'blue', true);
  pushBubble('正在連接應用程式', '模擬連線 GitHub / Firebase …', 'amber', true);
  pushBubble('驗證 GitHub 倉庫並更新網站', '比對分支、同步設定…', 'green', true);

  state.status='running'; state.stage='S1'; state.done=0; state.total=100; state.eta_sec=180; state.updated_at=Date.now();
  state.trace = []; render(); addTrace('初始化任務');

  const steps = [
    {p:10, stage:'S1', msg:'載入模組…', eta:160},
    {p:35, stage:'S2', msg:'蒐集資料…', eta:130},
    {p:65, stage:'S3', msg:'分析整併…', eta:80},
    {p:88, stage:'S3', msg:'生成輸出…', eta:30},
    {p:100,stage:'S4', msg:'完成 ✅', eta:0, done:true}
  ];
  let i=0;
  const timer = setInterval(()=>{
    const s = steps[i++];
    if(!s){ clearInterval(timer); return; }
    state.done = s.p; state.stage=s.stage; state.eta_sec=s.eta; state.updated_at=Date.now();
    addTrace(s.msg);
    if(s.done){ state.status='done'; pushBubble('部署完成', '網站已更新 / 任務完成', 'green', false); }
  }, 1400);
}

el('btnSim').addEventListener('click', startSimulation);
el('btnReset').addEventListener('click', ()=>{
  state.done=0; state.stage='S1'; state.status='init'; state.eta_sec=180; state.trace=[]; state.updated_at=Date.now();
  el('fill').style.background='linear-gradient(90deg,var(--primary),var(--accent))'; render();
  feed.innerHTML='';
});

if (online){
  el('hdr').classList.add('online');
  pushBubble('連線狀態', 'Firebase 已啟用：即時監聽 ' + TASK_ID, 'green', false);
  try{
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js');
    const { getDatabase, ref, onValue } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js');
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const r = ref(db, 'missions/' + TASK_ID);
    onValue(r, (snap)=>{
      const data = snap.val() || {};
      state.total = Number(data.total || 100);
      state.done  = Number(data.done  || 0);
      state.stage = data.stage || 'S1';
      state.status= data.status || 'running';
      state.eta_sec = data.eta_sec ?? 0;
      state.updated_at = data.updated_at || Date.now();
      state.trace = Array.isArray(data.trace) ? data.trace : [];
      render();
    });
  }catch(e){
    console.error(e);
    online = false;
    el('hdr').classList.remove('online');
  }
}else{
  // 無 Firebase：離線模式
  el('hdr').classList.remove('online');
  if (SIMULATE) startSimulation();
}
render();
</script>
</body>
</html>
